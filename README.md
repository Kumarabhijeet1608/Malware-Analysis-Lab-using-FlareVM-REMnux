# Establishing a Custom & Secure Malware Analysis Environment

Welcome to the journey of establishing a custom & secure malware analysis environment. In the ever-evolving landscape of cybersecurity, understanding and dissecting malicious software is a critical skill. In this guide, we’ll walk through the steps together, ensuring you have the right environment to analyze the malicious software.

## Safe Malware Handling Procedures

1. **Isolation**: Always conduct malware analysis in a controlled and isolated environment. Use virtual machines or dedicated hardware that is not connected to your main network.
2. **Virtualization**: Utilize virtualization tools like VMware or VirtualBox to create isolated environments for malware analysis. Snapshots can be useful for capturing the state of a system before running a sample.
3. **Air-Gapped Systems**: Consider using air-gapped systems (not connected to any network) for particularly sensitive or unknown samples to prevent any accidental spread.
4. **Network Segmentation**: Separate your malware analysis lab from the actual network to prevent any accidental spread of malware. This helps to contain the threat within the lab environment.
5. **Secure File Storage**: Store malware samples in encrypted containers or password-protected directories to prevent any accidental execution of the malware or unauthorized access.
6. **Regular System Snapshots**: Take regular snapshots of your analysis environment so that you can roll back to a clean state if necessary.
7. **Documentation**: Document every step of your analysis, including the tools used, the behavior observed, and any findings. This documentation is valuable for future reference and for sharing information with others.
8. **Hash Checking**: Verify the integrity of your malware samples using hash functions. This helps ensure that the samples have not been tampered with.

**Note**: Exercise caution and prioritize safety always in every step of the detonation process.

Guide for VM Installation:
[VM Installation Guide](https://www.youtube.com/watch?v=nvdnQX9UkMY)
## Required Resources for Setup

1. [VirtualBox (Free) - Download](https://www.virtualbox.org/)
2. [Windows 10 ISO file - Download](https://www.microsoft.com/en-us/software-download/windows10)
3. [REMnux VM - Download](https://remnux.org/)
4. [Flare-VM - Download](https://github.com/mandiant/flare-vm)

## Setup Process

### Step 1: Installing the Windows 10 VM

1. Open VirtualBox and click on “New”.
2. Enter the name of the virtual machine, select the type as Microsoft Windows, and version as Windows 10 (64-bit), then click “Next”.
3. Allocate memory size (at least 2048 MB), then click “Next”.
4. Select “Create a virtual hard disk now” and click “Create”.
5. Choose VDI (VirtualBox Disk Image) and click “Next”.
6. Select “Dynamically allocated” and click “Next”.
7. Specify the size of the virtual hard disk (at least 40 GB) and click “Create”.
8. With the VM selected, click on “Settings”.
9. Go to “Storage”, click on the empty optical drive, and select the Windows 10 ISO file.
10. Click “OK” and then start the VM.
11. Follow the installation prompts to install Windows 10.

### Step 2: Creating a Snapshot

1. Once the Windows installation is complete, log in using your credentials.
2. Click on “Machine” in the VirtualBox menu, then “Take Snapshot”.
3. Name the snapshot and click “OK”.

### Step 3: Installing Flare-VM

1. Open Microsoft Edge, download Chrome, and install it.
2. Use Chrome to search for the [mandiant/flare-vm GitHub repository](https://github.com/mandiant/flare-vm) and download the zip file.
3. Extract the downloaded zip file.
4. Open PowerShell as administrator and enable script execution:
    ```powershell
    Set-ExecutionPolicy Unrestricted -Force
    ```
5. Disable Windows Defender permanently:
    - Open `gpedit.msc`.
    - Navigate to Computer Configuration > Administrative Templates > Windows Components > Microsoft Defender Antivirus.
    - Double-click “Turn off Microsoft Defender Antivirus” and select “Enabled”. Click “Apply” and then “OK”.
    - Restart your computer.
6. Navigate to the directory where Flare-VM is installed using PowerShell and execute the `install.ps1` script:
    ```powershell
    .\install.ps1
    ```
    - Respond with `R` to run the script, `Y` to proceed, and enter your user password if prompted.
7. Wait for the script to complete. This process might take some time.

### Step 4: Creating a Snapshot

1. Once Flare-VM is installed, take another snapshot of the system following the steps in **Step 2**.

### Step 5: Setting up a Custom Network

1. Open the VirtualBox Network settings from the host machine.
2. Go to `File > Host Network Manager`.
3. Create a new Host-Only network and set the Subnet IP to `10.52.116.0` with a subnet mask of `255.255.255.0`.
4. Save the configuration and close the manager.

### Step 6: Changing Network Adapter Settings for Windows VM

1. Power off the Windows VM.
2. Go to VirtualBox settings for the Windows VM.
3. Click on “Network” and select “Host-only Adapter”.
4. Click “OK” to save the settings.

### Step 7: Setting up REMnux VM

1. Open VirtualBox and click on “File” > “Import Appliance”.
2. Choose the REMnux OVA file and click “Import”.
3. Once the VM is imported, change the network settings to “Host-only Adapter” following **Step 6**.
4. Start the REMnux VM.

### Step 8: Configuring REMnux VM

1. Open a terminal in REMnux and edit the `inetsim.conf` file:
    ```bash
    sudo nano /etc/inetsim/inetsim.conf
    ```
2. Uncomment the `start_service dns` line.
3. Set the `service_bind_address` to `0.0.0.0`.
4. Set the `dns_default_ip` to `10.52.116.128`.
5. Save and exit the editor (Ctrl+X, then Y).
6. Start the INetSim service:
    ```bash
    sudo inetsim
    ```

### Step 9: Configuring Windows VM Network Settings

1. Start the Windows VM.
2. Open “Network Connections” and select the Ethernet adapter.
3. Go to “Properties” > “Internet Protocol Version 4 (TCP/IPv4)” > “Properties”.
4. Set the Preferred DNS server to `10.52.116.128`.
5. Click “OK” and close the settings.

### Step 10: Verifying the Configuration

1. Open Command Prompt in the Windows VM and ping `10.52.116.129` to verify connectivity with REMnux VM.
2. Ping `google.com` or `8.8.8.8` to ensure the VM is isolated from the internet.
3. Open Chrome and navigate to `10.52.116.128` to verify the INetSim service is working.

## Conclusion

Establishing a malware analysis lab is a pivotal step toward enhancing cybersecurity skills and fortifying defenses against evolving digital threats. Through the careful selection and configuration of specialized tools, such as REMnux, and the creation of controlled environments like those enabled by INetSim, you can gain the ability to dissect malicious code without compromising the integrity of the broader network.

## For more information follow along:
[Defronix Acadamy](https://www.youtube.com/watch?v=3BwFfafLqG0&list=PLOJR6EhNalnuh6eovYTds8tbUI9EcRbtp&index=9)
